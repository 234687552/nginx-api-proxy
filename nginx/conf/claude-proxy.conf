# Claude API代理路由
location /claude/ {
    # 声明变量，后面使用
    set $claude_token "";

    # 请求校验和token获取
    access_by_lua_block {
        -- 1. 校验请求头
        local header_validator = require "header_validator"
        header_validator.check_and_exit()
        
        -- 2. 获取token
        local token_manager = require "claude.token_manager"
        ngx.var.claude_token = token_manager.get_token()
    }
    
    # URL重写：/claude/xxx → /xxx
    rewrite ^/claude/?(.*)$ /$1 break;
    
    # 代理到Claude API
    proxy_pass "https://api.anthropic.com";
    
    # SSL 配置
    proxy_ssl_verify off;
    proxy_ssl_server_name on;
    proxy_ssl_protocols TLSv1.2 TLSv1.3;
    
    # 流式响应配置
    proxy_request_buffering off;
    proxy_buffering off;
    proxy_cache off;
    
    # 流式传输超时设置
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # 透传所有请求头
    proxy_pass_request_headers on;
    
    # 只设置必要的头部
    proxy_set_header Host api.anthropic.com;
    proxy_set_header Authorization "Bearer $claude_token";
}